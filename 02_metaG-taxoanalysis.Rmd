---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(stringr)
library(phyloseq)
library(ggpubr)
library(DESeq2)
library(ALDEx2)
library(compositions)
library(clipr)
```


Tidy up data
```{r}
## OTU TABLE 
bracken_species_combined <- read.csv("data/metaG-taxonomy/bracken_species_combined.txt", sep="\t", header=T)
# Remove Xs
colnames(bracken_species_combined) <- sub("^X", "", colnames(bracken_species_combined))
# Split off data that just contains raw counts
bracken_species_combined_num <- bracken_species_combined %>%
  # the taxonomy IDs are completely different from the taxo table for some reason, so let's remove them
  dplyr::select(!c(contains("_frac"), taxonomy_lvl, taxonomy_id, "_num")) %>%
  dplyr::rename_all(~str_remove(., "_num")) %>%
  dplyr::rename(s=name) %>%
  # remove special characters and replace with _
  mutate(s = str_replace_all(s, "[^[:alnum:]]+", "_")) %>%
  # same with spaces
  mutate(s = str_replace_all(s, " ", "_")) %>%
  # remove _ at beginning or end of name
  mutate(s = str_replace_all(s, "^_+|_+$", "")) %>%
  column_to_rownames("s")

## TAXONOMY TABLE 
taxonomy <- read.csv("data/metaG-taxonomy/taxonomy.tsv", sep="\t", header=F)
# This messy solution is required because of the bad strings
taxonomy_sep <- taxonomy %>%
  dplyr::select(!2) %>%
  mutate(d=str_extract(V1, "(?<=d__)[^|]+")) %>%
  mutate(k=str_extract(V1, "(?<=k__)[^|]+")) %>%
  mutate(p=str_extract(V1, "(?<=p__)[^|]+")) %>%
  mutate(c=str_extract(V1, "(?<=c__)[^|]+")) %>%
  mutate(o=str_extract(V1, "(?<=o__)[^|]+")) %>%
  mutate(f=str_extract(V1, "(?<=f__)[^|]+")) %>%
  mutate(g=str_extract(V1, "(?<=g__)[^|]+")) %>%
  mutate(s=str_extract(V1, "(?<=s__)[^|]+")) %>%
  dplyr::select(!V1)
# Narrow down to those present in data
taxonomy_sep_select <- taxonomy_sep %>%
  # remove special characters and replace with _
  mutate(s = str_replace_all(s, "[^[:alnum:]]+", "_")) %>%
  # same with spaces
  mutate(s = str_replace_all(s, " ", "_")) %>%
  # remove _ at beginning or end of name
  mutate(s = str_replace_all(s, "^_+|_+$", "")) %>%
  dplyr::filter(s %in% rownames(bracken_species_combined_num)) %>%
  # finally, filter for bacteria
  dplyr::filter(d=="Bacteria")
# remove duplicate rows, assign species as rownames, sort
taxonomy_sep_select <- unique(taxonomy_sep_select) 
rownames(taxonomy_sep_select) <- taxonomy_sep_select$s

# update otu table such that only bacteria are present
bracken_species_combined_num <- bracken_species_combined_num[row.names(bracken_species_combined_num) %in% row.names(taxonomy_sep_select), ]
# put in same order
bracken_species_combined_num <- bracken_species_combined_num[match(row.names(taxonomy_sep_select), row.names(bracken_species_combined_num)), ]

#sanity check
setdiff(row.names(bracken_species_combined_num), row.names(taxonomy_sep_select))

# preview
head(bracken_species_combined_num)
head(taxonomy_sep_select)
```




Import updated names
```{r}
taxonomy_names_updated <- read.csv("data/metaG-taxonomy/taxonomic_names_updates.tsv", sep="\t", header=T) %>%
  # 1) Remove the prefix (p_, c_, o_, f_, g_, s_)
  mutate(across(everything(), ~ gsub("^[pcofgs]?_", "", .))) %>%
  # 2) Remove any leading underscore
  mutate(across(everything(), ~ gsub("^_", "", .))) %>%
  # 3) Replace spaces with underscores in the species column
  mutate(species = if("species" %in% names(.)) gsub(" ", "_", species) else species) %>%
  # 4) Rename the columns to just the first letter of the current name
  rename_with(~ substr(., 1, 1), -1) %>%
  mutate(across(everything(), ~ ifelse(. == "" | . == "_", NA, .))) %>%
  #column_to_rownames("oldTaxonomy") %>%
  mutate(d = NA, k = NA) %>%
  dplyr::select(d,k,p,c,o,f,g,s, everything()) %>%
  {rownames(.) <- gsub("\\.", "", rownames(.)); .}
```



There discrepancies between the old and new classifications.
The new classifications have updated names (Firmicutes is not Bacillota, for ex)
Since changing all the taxonomy would mess up the gloms for the remainder of the OTU table, let's just update the species names. 


Update the tax table
```{r}
taxonomy_sep_updated <- taxonomy_sep_select %>%
  left_join(taxonomy_names_updated[,c("s", "oldTaxonomy")], by = c("s" = "oldTaxonomy")) %>%
  mutate(s = ifelse(is.na(s.y), s, s.y)) %>%
  dplyr::select(-s.y) %>%
    # remove special cases, there were only 5
  distinct(s, .keep_all = TRUE)
nrow(taxonomy_sep_updated)
length(unique(taxonomy_sep_updated$s))

rownames(taxonomy_sep_updated) <- taxonomy_sep_updated$s 

```



Update the OTU table 
```{r}
bracken_species_combined_num_updated <- bracken_species_combined_num %>%
  rownames_to_column("s") %>%
  left_join(taxonomy_names_updated[,c("s", "oldTaxonomy")], by = c("s" = "oldTaxonomy")) %>%
  mutate(s = ifelse(is.na(s.y), s, s.y)) %>%
  dplyr::select(-s.y) %>%
  distinct(s, .keep_all = TRUE) %>%
  column_to_rownames("s")
```



Import metadata
```{r}
GMCC_covariates_all_batches <- read.csv("data/metadata/GMCC_covariates_all_batches.csv", header=T)
# Identify missing samples
remove_from_abun <- setdiff(colnames(bracken_species_combined_num_updated), GMCC_covariates_all_batches$SampleName)
remove_from_meta <- setdiff(GMCC_covariates_all_batches$SampleName, colnames(bracken_species_combined_num))
# Clean up metadata specific for this analysis
meta <- GMCC_covariates_all_batches %>%
  # remove underscores
  dplyr::mutate(SampleID = str_replace_all(SampleID, "_", "")) %>%
  dplyr::filter(!SampleName %in% remove_from_meta) %>%
  mutate(urbanism2=ifelse(country=="USA", "USA_urban", urbanism)) %>%
  mutate(SampleName2 = SampleName) %>%
  column_to_rownames("SampleName2") %>%
  mutate(shreya_samps = case_when(SampleName %in% c("6199II","4041OU","5905ZO","5744TZ","9261PK","8283LS","9794IK","6310FW") ~ "Selected",
                                  TRUE ~ "Other")) %>%
  dplyr::mutate(flag = case_when(
    country == "Ghana" ~ "data/metaG-QC/flags/ghana.svg",
    country == "Malaysia" ~ "data/metaG-QC/flags/malaysia.svg",
    country == "Nigeria" ~ "data/metaG-QC/flags/nigeria.svg",
    country == "Rwanda" ~ "data/metaG-QC/flags/rwanda.svg",
    country == "USA" ~ "data/metaG-QC/flags/usa.svg")) 
```

Check metadata for samples on lower end of read counts (1-5 million- do these contain rare taxa?)
QC plot of total reads pre and post alignment
```{r}
post_trim_reads <- read.table("data/metaG-QC/trimmed_reads_summary.txt", header=1)  %>%
  mutate(Sample = gsub("_P_1_kneaddata", "", Sample)) %>%
  dplyr::filter(Sample %in% meta$SampleName)
total_reads <- as.data.frame(colSums(bracken_species_combined_num)) %>%
  rownames_to_column("Sample") %>%
  dplyr::filter(Sample %in% meta$SampleName) %>%
  dplyr::rename("post_align" = 2) %>%
  merge(post_trim_reads, by="Sample") %>%
  dplyr::mutate(mapping_rate = post_align / Trimmed_Pair1_Reads) %>%
  dplyr::mutate(trimmed_sum = Trimmed_Pair1_Reads + Trimmed_Pair2_Reads)
```
```{r}
#ggplot(total_reads, aes(x=reorder(Sample, trimmed_sum), y=trimmed_sum)) +
# Define the bin width
bin_width <- 10000000

# Calculate breaks and labels
breaks <- seq(
  from = floor(min(total_reads$trimmed_sum) / bin_width) * bin_width,
  to = ceiling(max(total_reads$trimmed_sum) / bin_width) * bin_width,
  by = bin_width
)
centers <- breaks[-length(breaks)] + bin_width / 2  # Bin centers

# Generate labels in scientific notation with a new line between ranges
labels <- paste0(
  scales::label_scientific()(breaks[-length(breaks)]), 
  " - \n", 
  scales::label_scientific()(breaks[-1])
)

# Plot with debugging aids
ggplot(total_reads, aes(x = trimmed_sum)) +
  geom_histogram(
    binwidth = bin_width, 
    fill = "#1780a1", 
    color = "black", 
    boundary = min(breaks)  # Ensure alignment with breaks
  ) +
  scale_x_continuous(
    breaks = centers,  # Use bin centers for labels
    labels = labels
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 22)) +  # Ensure the y-axis starts at 0
  theme_linedraw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(hjust = 0.5, size = 10)  # Center alignment
  ) 

```

```{r}
total_reads_annotated <- total_reads %>%
  dplyr::rename(SampleName=Sample) %>%
  merge(meta[,c("SampleName", "urbanism", "lifestyle2", "SampleID", "country")], by="SampleName")
```

Impute some missing values for USA samples

```{r}
### I GET THIS INFORMATION FURTHER DOWNSTREAM IN THIS MARKDOWN DOC
### USING FIRST 5 PCs TO INFER AGE AND SEX OF USA SAMPLES
### I KNOW THIS ISN'T A PERFECT SOLUTION SINCE WE ARE CORRECTING FOR THESE VARS
### BUT I DON'T THINK THEY WILL BE EXTREMELY IMPORTANT 

#meta_imputation <- genus_clr_dist_vectors %>%
#  as.data.frame() %>%
#  dplyr::select(1:5) %>%
#  rownames_to_column("SampleName") %>%
#  merge(meta[,c("SampleName", "age", "sex")], by="SampleName") %>%
#  mutate(age = if_else(age == "unknown", NA_character_, age)) %>%
#  mutate(sex = if_else(sex == "unknown", NA_character_, sex)) %>%
#  column_to_rownames("SampleName")

#library(VIM)

# Impute missing values using KNN imputation
#imputed_data <- kNN(meta_imputation, k = 5)
#rownames(imputed_data) <- rownames(meta_imputation)
```
Update metadata
```{r}
imputed_samples <- data.frame(
  SampleName = c("FMG110", "FMG111", "FMG112", "FMG28", "FMG65"),
  age = c(29,59,39,29,39),
  sex= c("F","M","F","M","M")
)
 
meta$age[meta$SampleName %in% imputed_samples$SampleName] <- imputed_samples$age
meta$age <- as.numeric(meta$age)
meta$sex[meta$SampleName %in% imputed_samples$SampleName] <- imputed_samples$sex
```


Convert to phyloseq format
```{r}
abun_phy <- bracken_species_combined_num_updated %>%
    # Prune abundance table of samples missing from metadata
    dplyr::select(!all_of(remove_from_abun)) %>%
    as.matrix() %>%
    otu_table(taxa_are_rows = T) 

tax_phy <- taxonomy_sep_updated %>%
    as.matrix() %>%
    tax_table() 

meta_phy <- sample_data(meta)

# run phyloseq
phy <- phyloseq(abun_phy, tax_phy, meta_phy)
phy
```




Glom to different taxonomic levels. Important to update row names.
```{r}
glom_func <- function(phy, tax_level_quotes) {
  phy_glom <- tax_glom(phy, tax_level_quotes) 
  otu <- as.data.frame(phyloseq::otu_table(phy_glom))
  tax <- as.data.frame(phyloseq::tax_table(phy_glom)) %>%
    dplyr::select(d:tax_level_quotes)
  row.names(tax) <- tax[,tax_level_quotes]
  row.names(otu) <- row.names(tax)
  otu <- otu_table(as.matrix(otu), taxa_are_rows = T)
  tax <- tax_table(as.matrix(tax))
  phy_glom_updated <- phyloseq(otu, tax, meta_phy)
  return(phy_glom_updated )
}

phy_s <- glom_func(phy, "s")
phy_g <- glom_func(phy, "g")
phy_f <- glom_func(phy, "f")
phy_o <- glom_func(phy, "o")
phy_c <- glom_func(phy, "c")
phy_p <- glom_func(phy, "p")


paste("# OTUs s: ", nrow(tax_table(phy_s)))
paste("# OTUs g: ", nrow(tax_table(phy_g)))
paste("# OTUs f: ", nrow(tax_table(phy_f)))
paste("# OTUs o: ", nrow(tax_table(phy_o)))
paste("# OTUs c: ", nrow(tax_table(phy_c)))
paste("# OTUs p: ", nrow(tax_table(phy_p)))
```


Filtering: let's retain taxa found at 0.001 relative abundance in at least 25% of the rural OR at least 25% of the urban samples
```{r}
# Create list of the SampleIDs corresponding to different groups
urbanism_urban <- unlist(subset(meta$SampleName, meta$urbanism == "urban"))
urbanism_urban <- urbanism_urban[!(urbanism_urban %in% remove_from_meta)]
urbanism_rural <- unlist(subset(meta$SampleName, meta$urbanism == "rural"))
urbanism_rural <- urbanism_rural[!(urbanism_rural %in% remove_from_meta)]

keep_taxa_func <- function(phy_object){
  
  # first transform to relative abundance
  phy_r = transform_sample_counts(phy_object,function(x){x / sum(x)})
  
  taxa_filt <- as.data.frame(otu_table(phy_r)) %>%
  rownames_to_column('OTU') %>%
  # Create a new column that indicates the percentage of samples that have a relative abundance greater than 0.001
  dplyr::mutate(perc_greaterthan_1e3_urbanism_urban = 
                  rowSums(across(all_of(urbanism_urban)) > 0.001)/length(urbanism_urban)) %>%
  dplyr::mutate(perc_greaterthan_1e3_urbanism_rural = 
                  rowSums(across(all_of(urbanism_rural)) > 0.001)/length(urbanism_rural)) %>%
  # Select taxa that are found at 0.001 RA in at least 50% urban OR 50% rural
  subset(perc_greaterthan_1e3_urbanism_urban >= 0.25 | perc_greaterthan_1e3_urbanism_rural >= 0.25) %>%
  dplyr::select(-(starts_with("perc_greaterthan_1e3"))) %>%
  `row.names<-`(., NULL) %>%
  column_to_rownames("OTU") %>%
  as.matrix()
  
  # Extract names of taxa to keep
  keeptaxa = rownames(taxa_filt)
  
  return(keeptaxa)
}

phy_s_keep <- keep_taxa_func(phy_s)
phy_g_keep <- keep_taxa_func(phy_g)
phy_f_keep <- keep_taxa_func(phy_f)
phy_o_keep <- keep_taxa_func(phy_o)
phy_c_keep <- keep_taxa_func(phy_c)
phy_p_keep <- keep_taxa_func(phy_p)

  
# Execute prevalence filter, using `prune_taxa()` function
phy_filt_s <- prune_taxa(phy_s_keep, phy_s)
phy_filt_g <- prune_taxa(phy_g_keep, phy_g)
phy_filt_f <- prune_taxa(phy_f_keep, phy_f)
phy_filt_o <- prune_taxa(phy_o_keep, phy_o)
phy_filt_c <- prune_taxa(phy_c_keep, phy_c)
phy_filt_p <- prune_taxa(phy_p_keep, phy_p)

paste("Total number of taxa (filt cutoff = RA > 0.001 in 25% rural or urban")
paste("pre-filt s: ", nrow(tax_table(phy_s)))
paste0("post-filt s: ", nrow(tax_table(phy_filt_s)))
paste("pre-filt g: ", nrow(tax_table(phy_g)))
paste0("post-filt g: ", nrow(tax_table(phy_filt_g)))
paste("pre-filt f: ", nrow(tax_table(phy_f)))
paste0("post-filt f: ", nrow(tax_table(phy_filt_f)))
paste("pre-filt o: ", nrow(tax_table(phy_o)))
paste0("post-filt o: ", nrow(tax_table(phy_filt_o)))
paste("pre-filt c: ", nrow(tax_table(phy_c)))
paste0("post-filt c: ", nrow(tax_table(phy_filt_c)))
paste("pre-filt p: ", nrow(tax_table(phy_p)))
paste0("post-filt p: ", nrow(tax_table(phy_filt_p)))

```
```{r}
# Total number of taxa pre-filt
nrow(tax_table(phy_s)) +
  nrow(tax_table(phy_g)) +
  nrow(tax_table(phy_f)) +
  nrow(tax_table(phy_o)) +
  nrow(tax_table(phy_c)) +
  nrow(tax_table(phy_p))

# post-filt
nrow(tax_table(phy_filt_s)) +
  nrow(tax_table(phy_filt_g)) +
  nrow(tax_table(phy_filt_f)) +
  nrow(tax_table(phy_filt_o)) +
  nrow(tax_table(phy_filt_c)) +
  nrow(tax_table(phy_filt_p))
```

Save all to file
```{r}
saveRDS(phy_filt_s, "results/rds/phy_filt_s.rds")
saveRDS(phy_filt_g, "results/rds/phy_filt_g.rds")
saveRDS(phy_filt_f, "results/rds/phy_filt_f.rds")
saveRDS(phy_filt_o, "results/rds/phy_filt_o.rds")
saveRDS(phy_filt_c, "results/rds/phy_filt_c.rds")
saveRDS(phy_filt_p, "results/rds/phy_filt_p.rds")
```











```{r}
covariates <- phyloseq::sample_data(phy_filt_g) %>%
  data.frame() %>%
  dplyr::select(urbanism, country, age, sex)
mm <- model.matrix(~ urbanism + country + age + sex, covariates)

# phylum
x.glm_p <- aldex.clr(as.data.frame(otu_table(phy_filt_p)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_p <- aldex.glm(x.glm_p, mm)
glm.eff_p <- aldex.glm.effect(x.glm_p)
glm_p_res <- cbind(glm.eff_p[1], glm.test_p) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_p_sig <- glm_p_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)

# class
x.glm_c <- aldex.clr(as.data.frame(otu_table(phy_filt_c)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_c <- aldex.glm(x.glm_c, mm)
glm.eff_c <- aldex.glm.effect(x.glm_c)
glm_c_res <- cbind(glm.eff_c[1], glm.test_c) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_c_sig <- glm_c_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)

# order
x.glm_o <- aldex.clr(as.data.frame(otu_table(phy_filt_o)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_o <- aldex.glm(x.glm_o, mm)
glm.eff_o <- aldex.glm.effect(x.glm_o)
glm_o_res <- cbind(glm.eff_o[1], glm.test_o) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_o_sig <- glm_o_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)

# family
x.glm_f <- aldex.clr(as.data.frame(otu_table(phy_filt_f)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_f <- aldex.glm(x.glm_f, mm)
glm.eff_f <- aldex.glm.effect(x.glm_f)
glm_f_res <- cbind(glm.eff_f[1], glm.test_f) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_f_sig <- glm_f_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)

# genus
x.glm_g <- aldex.clr(as.data.frame(otu_table(phy_filt_g)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_g <- aldex.glm(x.glm_g, mm)
glm.eff_g <- aldex.glm.effect(x.glm_g)
glm_g_res <- cbind(glm.eff_g[1], glm.test_g) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_g_sig <- glm_g_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)

# species
x.glm_s <- aldex.clr(as.data.frame(otu_table(phy_filt_s)), mm, mc.samples=128, denom="all", verbose=T)
glm.test_s <- aldex.glm(x.glm_s, mm)
glm.eff_s <- aldex.glm.effect(x.glm_s)
glm_s_res <- cbind(glm.eff_s[1], glm.test_s) %>%
  rename_with(~ str_replace_all(., ":", "_")) 
glm_s_sig <- glm_s_res %>%
  dplyr::filter(urbanismurban_pval.holm < 0.1)
```


Combine with taxonomy for supplementary table
```{r}
aldex2_summary_func <- function(res_df, tax_level_quotes) {
  summary_table <- res_df %>%
  rownames_to_column(tax_level_quotes) %>%
  #left_join(taxonomy_sep_updated, by=tax_level_quotes)  %>%
  dplyr::select(tax_level_quotes,urbanismurban.effect,urbanismurban_pval.holm) %>%
  #dplyr::select(1, urbanismurban.effect,urbanismurban_pval.holm) %>%
  #dplyr::rename(taxa=1) %>%
  dplyr::rename(effect=urbanismurban.effect) %>%
  dplyr::rename(pval.holm=urbanismurban_pval.holm) %>%
  dplyr::mutate(enriched_in = case_when(effect > 0 ~ "Industrialized",
                                        effect < 0 ~ "Non-Industrialized")) %>%
  dplyr::arrange(effect)
}
  
glm_s_table <- aldex2_summary_func(glm_s_res, "s")
glm_g_table <- aldex2_summary_func(glm_g_res, "g")
glm_f_table <- aldex2_summary_func(glm_f_res, "f")
glm_o_table <- aldex2_summary_func(glm_o_res, "o")
glm_c_table <- aldex2_summary_func(glm_c_res, "c")
glm_p_table <- aldex2_summary_func(glm_p_res, "p")

#glm_s_sig_table <- glm_s_table %>% dplyr::filter(pval.holm < 0.1) 
#write_clip(glm_s_sig_table)
#glm_g_sig_table <- glm_g_table %>% dplyr::filter(pval.holm < 0.1) %>% dplyr::distinct()
#write_clip(glm_g_sig_table)
#glm_f_sig_table <- glm_f_table %>% dplyr::filter(pval.holm < 0.1) %>% dplyr::distinct()
#write_clip(glm_f_sig_table)
#glm_o_sig_table <- glm_o_table %>% dplyr::filter(pval.holm < 0.1)  %>% dplyr::distinct()
#write_clip(glm_o_sig_table)
#glm_c_sig_table <- glm_c_table %>% dplyr::filter(pval.holm < 0.1) %>% dplyr::distinct()
#write_clip(glm_c_sig_table)
#glm_p_sig_table <- glm_p_table %>% dplyr::filter(pval.holm < 0.1) %>% dplyr::distinct()
#write_clip(glm_p_sig_table)

# save for downstream use
glm_results_urbanism <- list(s=glm_s_table, g=glm_g_table, f=glm_f_table, o=glm_o_table, c=glm_c_table, p=glm_p_table)
saveRDS(glm_results_urbanism, "results/rds/glm_results_urbanism.rds")
```


More functions
```{r}
aldex2_test <- function(phy) {
  ALDEx2::aldex.clr(as.data.frame(phyloseq::otu_table(phy)), 
                    phyloseq::sample_data(phy)$urbanism, 
                    mc.samples=128, 
                    denom="all", 
                    verbose=F,
                    useMC=T) }

aldex2_cts <- function(aldex_obj){
  x.counts <- getMonteCarloInstances(aldex_obj)
  # Calculate row means for each nested list
  row_means_list <- lapply(x.counts, function(i) {
    data.frame(rowMeans(i))
    })
  row_means_list <- lapply(names(row_means_list), function(list_name) {
    df <- row_means_list[[list_name]]
    colnames(df) <- list_name
    return(df)
    })
  # Convert the list of row means into a data frame and CLR transform
  row_means_df <- dplyr::bind_cols(row_means_list)
  return(row_means_df)
}




aldex2_res <- function(aldex_obj) {
  x <- aldex_obj
  x.tt <- aldex.ttest(x, hist.plot=F, paired.test=FALSE, verbose=FALSE)
  x.effect <- aldex.effect(x, CI=T, verbose=F, include.sample.summary=F, 
  paired.test=FALSE, glm.conds=NULL, useMC=F)
  x.all <- data.frame(x.tt,x.effect)
  return(x.all)
}

# Save as df
aldex2_sig <- function(aldex2_res, tax_level_quotes){
  aldex2_res %>%
    dplyr::filter(wi.eBH < 0.01) %>%
    arrange(effect, wi.eBH) %>%
    mutate(DA_urbanism = case_when(effect > 0 ~ "urban",
                                   effect < 0 ~ "rural")) %>%
    mutate(tax = tax_level_quotes) %>% 
    dplyr::select(tax, everything())
  }

# Plot sig and non-sig results
aldex2_plot <- function(aldex_result) {
  ALDEx2::aldex.plot(aldex_result, type="MW", test="wilcox", called.cex = 1, cutoff = 0.01)
}

```


```{r}
## Apply 

# Create aldex2 object
aldex2_clr_s <- aldex2_test(phy_filt_s)
aldex2_clr_g <- aldex2_test(phy_filt_g)
aldex2_clr_f <- aldex2_test(phy_filt_f)
aldex2_clr_o <- aldex2_test(phy_filt_o)
aldex2_clr_c <- aldex2_test(phy_filt_c)
aldex2_clr_p <- aldex2_test(phy_filt_p)

# Extract CLR-normalized counts
aldex2_clr_s_cts <- aldex2_cts(aldex2_clr_s)
aldex2_clr_g_cts <- aldex2_cts(aldex2_clr_g)
aldex2_clr_f_cts <- aldex2_cts(aldex2_clr_f)
aldex2_clr_o_cts <- aldex2_cts(aldex2_clr_o)
aldex2_clr_c_cts <- aldex2_cts(aldex2_clr_c)
aldex2_clr_p_cts <- aldex2_cts(aldex2_clr_p)

#write.csv(aldex2_clr_s_cts, "results/docs/clr_species.csv")

# df of results
aldex2_clr_s_res <- aldex2_res(aldex2_clr_s)
aldex2_clr_g_res <- aldex2_res(aldex2_clr_g)
aldex2_clr_f_res <- aldex2_res(aldex2_clr_f)
aldex2_clr_o_res <- aldex2_res(aldex2_clr_o)
aldex2_clr_c_res <- aldex2_res(aldex2_clr_c)
aldex2_clr_p_res <- aldex2_res(aldex2_clr_p)

# sig results only
aldex2_clr_s_sig <- aldex2_sig(aldex2_clr_s_res, "s")
aldex2_clr_g_sig <- aldex2_sig(aldex2_clr_g_res, "g")
aldex2_clr_f_sig <- aldex2_sig(aldex2_clr_f_res, "f")
aldex2_clr_o_sig <- aldex2_sig(aldex2_clr_o_res, "o")
aldex2_clr_c_sig <- aldex2_sig(aldex2_clr_c_res, "c")
aldex2_clr_p_sig <- aldex2_sig(aldex2_clr_p_res, "p")

# bind sig results
aldex2_clr_all_sig <- rbind(aldex2_clr_s_sig, aldex2_clr_g_sig) %>%
  rbind(aldex2_clr_f_sig) %>%
  rbind(aldex2_clr_o_sig) %>%
  rbind(aldex2_clr_c_sig) %>%
  rbind(aldex2_clr_p_sig)

write.csv(aldex2_clr_all_sig, "results/docs/DA_microbe_aldex2.csv")

# plot
aldex2_plot(aldex2_clr_s_res)
aldex2_plot(aldex2_clr_g_res)
aldex2_plot(aldex2_clr_f_res)
aldex2_plot(aldex2_clr_o_res)
aldex2_plot(aldex2_clr_c_res)
aldex2_plot(aldex2_clr_p_res)

```

```{r}
da_s <- aldex2_clr_s_sig %>%
  rownames_to_column("Species") %>%
  arrange(effect)
da_s$Species <- factor(da_s$Species, levels = unlist(da_s$Species))

ggplot(da_s, aes(x=effect, y=Species)) +
  geom_point(aes(color=wi.eBH))
ggsave("results/figs/metaG-PCoA/sup_DA.png", width=5, height=7.5)
```
```{r}
da_g <- aldex2_clr_g_sig %>%
  rownames_to_column("Genus") %>%
  arrange(effect)
da_g$Genus <- factor(da_g$Genus, levels = unlist(da_g$Genus))

ggplot(da_g, aes(x=effect, y=Genus)) +
  geom_point(aes(color=wi.eBH))
```




Apply CLR transformed values to phyloseq objects
```{r}
phy_clr_filt_s <- phy_filt_s
otu_table(phy_clr_filt_s) <- otu_table(aldex2_clr_s_cts, taxa_are_rows = T)

phy_clr_filt_g <- phy_filt_g
otu_table(phy_clr_filt_g) <- otu_table(aldex2_clr_g_cts, taxa_are_rows = T)

phy_clr_filt_f <- phy_filt_f
otu_table(phy_clr_filt_f) <- otu_table(aldex2_clr_f_cts, taxa_are_rows = T)

phy_clr_filt_o <- phy_filt_o
otu_table(phy_clr_filt_o) <- otu_table(aldex2_clr_o_cts, taxa_are_rows = T)

phy_clr_filt_c <- phy_filt_c
otu_table(phy_clr_filt_c) <- otu_table(aldex2_clr_c_cts, taxa_are_rows = T)

phy_clr_filt_p <- phy_filt_p
otu_table(phy_clr_filt_p) <- otu_table(aldex2_clr_p_cts, taxa_are_rows = T)

paste("ALDEx2 significant OTUs:",nrow(aldex2_clr_all_sig))

row.names(otu_table(phy_filt_f))
```

Alpha diversity of urban and rural
```{r}
phy_shannon <- estimate_richness(phy) %>%
  rownames_to_column("SampleName") %>%
  dplyr::mutate(SampleName = str_remove(SampleName, "^X")) %>%
  left_join(meta[,c("SampleName", "urbanism")], by ="SampleName")

write.csv(phy_shannon, "data/metadata/richness.csv")

ggplot(phy_shannon, aes(x=urbanism, y=Shannon, fill=urbanism)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1")) +
  geom_point()

# Perform Wilcoxon test
wilcox_test <- wilcox.test(Shannon ~ urbanism, data = phy_shannon)

# Print the p-value
print(wilcox_test$p.value)

# Perform t-test
t_test <- t.test(Shannon ~ urbanism, data = phy_shannon)

# Print the p-value
print(t_test$p.value)

```
```{r}
ggplot(phy_shannon, aes(x=Shannon, group=urbanism, fill=urbanism)) +
    geom_density(alpha=0.5) +
    scale_fill_manual(values=c("#6FBD8B", "#7B2BC1")) +
    scale_color_manual(values=c("#6FBD8B", "#7B2BC1")) +
 # Add vertical lines for the mean
  geom_vline(data = summary_stats, aes(xintercept = mean_shannon, color = urbanism), linetype = "solid") +
  # Add vertical lines for the median
  geom_vline(data = summary_stats, aes(xintercept = median_shannon, color = urbanism), linetype = "dashed") +
  theme_linedraw()
```
Filter phy_shannon object
```{r}
meta2 <- read.csv("data/metadata/meta_RNAseq.csv", row.names = 1) %>%
  mutate(Batch = as.factor(Batch)) %>%
  mutate(Total.Reads_scaled = scale(Total.Reads)[, 1])
phy_shannon_filt <- phy_shannon %>%
  left_join(meta2[,c("SampleName", "SampleID", "Batch", "Total.Reads")], by="SampleName") %>%
  # This sample was bad quality 
  dplyr::filter(!SampleID %in% c("GMCC1S1")) %>%
  # These samples were outliers amongst the RNAseq
  dplyr::filter(!SampleID %in% c("GMCC4S10", "GMCC3S7", "GMCC4C6", "GMCC5C5", "GMCC5C4", "GMCC5C3", "GMCC4S12")) %>% #NEW ADDITIONS AS OF NOV 2 2024 ARE GMCC4S12 AND GMCC3C1
  # These samples were not used to treat the colonocytes
  dplyr::filter(!SampleName %in% c("1127XT", "1462QI", "3364PX", "3553XK", "3606IJ", "9423WC"))
```
Order this by shannon and then partition into 5 groups
```{r}
phy_shannon5 <- phy_shannon_filt %>%
  dplyr::select(Shannon, SampleID, SampleName) %>%
  dplyr::arrange(Shannon) %>%
  dplyr::mutate(group = ntile(Shannon, 5))

shannon5 <- phy_shannon5 %>%
  group_by(group) %>%
  summarise(
    median_shannon= median(Shannon),
    sd_shannon <- sd(Shannon)
  )

# Split the data into a nested list based on the 'group' column
shannon5_nested <- split(phy_shannon5, phy_shannon5$group)
shannon5_nested <- lapply(shannon5_nested, dplyr::select, -group, -Shannon)

# add controls
control_rows <- meta2 %>% dplyr::filter(coculture=="control") %>% dplyr::select(SampleID, SampleName) 
shannon5_nested <- lapply(shannon5_nested, rbind,control_rows) %>%
  purrr::map(~ merge(.x, meta2[,c("SampleID","Batch", "urbanism", "Total.Reads_scaled")], by = "SampleID")) 
shannon5_nested <- lapply(shannon5_nested, function(df) {
  dplyr::mutate(df, coculture = dplyr::case_when(
    is.na(df$urbanism) ~ "control", 
    TRUE ~ "coculture"
  ))
})

saveRDS(shannon5_nested, "results/rds/shannon5_nest.rds")
write.csv(shannon5 , "results/docs/shannon5_list.csv")
```


Create 1000 groups of 15 samples with median shannon + sd
```{r}
set.seed(123)  # Set a seed for reproducibility

# Create an empty dataframe to store results
shannon1000 <- data.frame(
  iteration = integer(),
  median_shannon = numeric(),
  sd_shannon = numeric(),
  sample_ids = character(),
  stringsAsFactors = FALSE
)

# Perform 1000 iterations
for (i in 1:1000) {
  # Randomly sample 15 rows from phy_shannon
  sampled <- phy_shannon_filt[sample(nrow(phy_shannon_filt), 15), ]
  
  # Calculate median and standard deviation of Shannon
  median_shannon <- median(sampled$Shannon)
  sd_shannon <- sd(sampled$Shannon)
  
  # Get sample names as a semicolon-separated string
  sample_ids <- paste(sampled$SampleID, collapse = ";")
  
  # Append results to the dataframe
  shannon1000 <- rbind(shannon1000, data.frame(
    iteration = i,
    median_shannon = median_shannon,
    sd_shannon = sd_shannon,
    sample_ids = sample_ids,
    stringsAsFactors = FALSE
  ))
}

# View results
head(shannon1000)


```
Plot results
```{r}
shannon1000 <- shannon1000 %>%
  dplyr::distinct(sample_ids, .keep_all = TRUE)

ggplot(shannon1000, aes(x=median_shannon)) +
  geom_histogram() 

ggplot(shannon1000, aes(x=sd_shannon)) +
  geom_histogram() 

ggplot(shannon1000, aes(x=median_shannon, y=sd_shannon)) +
  geom_point() 
```
Create 1000 groups of 15 samples with median shannon + sd
Do this for urban and rural only
```{r}
set.seed(123)  # Set a seed for reproducibility

# Create an empty dataframe to store results
shannon1000_urban <- data.frame(
  iteration = integer(),
  median_shannon = numeric(),
  sd_shannon = numeric(),
  sample_ids = character(),
  stringsAsFactors = FALSE
)

phy_shannon_filt_urban <- phy_shannon_filt %>%
  dplyr::filter(urbanism=="urban")

# Perform 1000 iterations
for (i in 1:1000) {
  # Randomly sample 15 rows from phy_shannon
  sampled <- phy_shannon_filt_urban[sample(nrow(phy_shannon_filt_urban), 15), ]
  
  # Calculate median and standard deviation of Shannon
  median_shannon <- median(sampled$Shannon)
  sd_shannon <- sd(sampled$Shannon)
  
  # Get sample names as a semicolon-separated string
  sample_ids <- paste(sampled$SampleID, collapse = ";")
  
  # Append results to the dataframe
  shannon1000_urban <- rbind(shannon1000_urban, data.frame(
    iteration = i,
    median_shannon = median_shannon,
    sd_shannon = sd_shannon,
    sample_ids = sample_ids,
    stringsAsFactors = FALSE
  ))
}

```
rural
```{r}
set.seed(123)  # Set a seed for reproducibility

# Create an empty dataframe to store results
shannon1000_rural <- data.frame(
  iteration = integer(),
  median_shannon = numeric(),
  sd_shannon = numeric(),
  sample_ids = character(),
  stringsAsFactors = FALSE
)

phy_shannon_filt_rural <- phy_shannon_filt %>%
  dplyr::filter(urbanism=="rural")

# Perform 1000 iterations
for (i in 1:1000) {
  # Randomly sample 15 rows from phy_shannon
  sampled <- phy_shannon_filt_rural[sample(nrow(phy_shannon_filt_rural), 15), ]
  
  # Calculate median and standard deviation of Shannon
  median_shannon <- median(sampled$Shannon)
  sd_shannon <- sd(sampled$Shannon)
  
  # Get sample names as a semicolon-separated string
  sample_ids <- paste(sampled$SampleID, collapse = ";")
  
  # Append results to the dataframe
  shannon1000_rural <- rbind(shannon1000_rural, data.frame(
    iteration = i,
    median_shannon = median_shannon,
    sd_shannon = sd_shannon,
    sample_ids = sample_ids,
    stringsAsFactors = FALSE
  ))
}

```

Arrange by SD and slice
```{r}
shannon100 <- shannon1000 %>%
  dplyr::arrange(sd_shannon) %>%
  dplyr::slice_head(n = 100)

set.seed(123)
shannon100_random <- shannon1000 %>%
  dplyr::slice_sample(n = 100)

set.seed(123)
shannon100_random_urban <- shannon1000_urban %>%
  dplyr::slice_sample(n = 100)

set.seed(123)
shannon100_random_rural <- shannon1000_rural %>%
  dplyr::slice_sample(n = 100)

ggplot(shannon100, aes(x=median_shannon)) +
  geom_histogram() 

ggplot(shannon100, aes(x=sd_shannon)) +
  geom_histogram() 

```
```{r}
controls <- meta2 %>% dplyr::filter(coculture=="control") %>% dplyr::select(SampleID) %>%
 unlist()

shannon100_list <- shannon100 %>%
  dplyr::mutate(controls = paste(controls, collapse = ";")) %>%
  dplyr::mutate(iteration = paste0("i", iteration))

shannon100_nest <- shannon100_list %>%
  split(.$iteration) %>%  # Split the data by 'iteration'
  purrr::set_names(names(.) %>% as.character())  %>%
  purrr::map(~ .x %>%
               # Convert the sample_ids and controls into long format (one sample per row)
               dplyr::bind_rows(
                 tibble(SampleID = unlist(strsplit(.x$sample_ids, ";")), coculture = "coculture"),
                 tibble(SampleID = unlist(strsplit(.x$controls, ";")), coculture = "control")
               ) %>%
               # Remove any extra columns and keep only 'sample' and 'type'
               dplyr::select(SampleID, coculture) %>%
               # Filter out rows where sample is NA or empty
               dplyr::filter(!is.na(sample) & SampleID != "")
             ) %>%
  purrr::map(~ merge(.x, meta2[,c("SampleID", "SampleName", "Batch", "urbanism", "Total.Reads_scaled")], by = "SampleID"))

saveRDS(shannon100_nest, "results/rds/shannon100_nest.rds")
write.csv(shannon100_list, "results/docs/shannon100_list.csv")
  
```
random
```{r}
shannon100_random_list <- shannon100_random %>%
  dplyr::mutate(controls = paste(controls, collapse = ";")) %>%
  dplyr::mutate(iteration = paste0("i", iteration))

shannon100_random_nest <- shannon100_random_list %>%
  split(.$iteration) %>%  # Split the data by 'iteration'
  purrr::set_names(names(.) %>% as.character())  %>%
  purrr::map(~ .x %>%
               # Convert the sample_ids and controls into long format (one sample per row)
               dplyr::bind_rows(
                 tibble(SampleID = unlist(strsplit(.x$sample_ids, ";")), coculture = "coculture"),
                 tibble(SampleID = unlist(strsplit(.x$controls, ";")), coculture = "control")
               ) %>%
               # Remove any extra columns and keep only 'sample' and 'type'
               dplyr::select(SampleID, coculture) %>%
               # Filter out rows where sample is NA or empty
               dplyr::filter(!is.na(sample) & SampleID != "")
             ) %>%
  purrr::map(~ merge(.x, meta2[,c("SampleID", "SampleName", "Batch", "urbanism", "Total.Reads_scaled")], by = "SampleID"))

saveRDS(shannon100_random_nest, "results/rds/shannon100_random_nest.rds")
write.csv(shannon100_random_list, "results/docs/shannon100_random_list.csv")
```
random urban
```{r}
shannon100_random_urban_list <- shannon100_random_urban %>%
  dplyr::mutate(controls = paste(controls, collapse = ";")) %>%
  dplyr::mutate(iteration = paste0("i", iteration))

shannon100_random_urban_nest <- shannon100_random_urban_list %>%
  split(.$iteration) %>%  # Split the data by 'iteration'
  purrr::set_names(names(.) %>% as.character())  %>%
  purrr::map(~ .x %>%
               # Convert the sample_ids and controls into long format (one sample per row)
               dplyr::bind_rows(
                 tibble(SampleID = unlist(strsplit(.x$sample_ids, ";")), coculture = "coculture"),
                 tibble(SampleID = unlist(strsplit(.x$controls, ";")), coculture = "control")
               ) %>%
               # Remove any extra columns and keep only 'sample' and 'type'
               dplyr::select(SampleID, coculture) %>%
               # Filter out rows where sample is NA or empty
               dplyr::filter(!is.na(sample) & SampleID != "")
             ) %>%
  purrr::map(~ merge(.x, meta2[,c("SampleID", "SampleName", "Batch", "urbanism", "Total.Reads_scaled")], by = "SampleID"))

saveRDS(shannon100_random_urban_nest, "results/rds/shannon100_random_urban_nest.rds")
write.csv(shannon100_random_urban_list, "results/docs/shannon100_random_urban_list.csv")
```
random rural
```{r}
shannon100_random_rural_list <- shannon100_random_rural %>%
  dplyr::mutate(controls = paste(controls, collapse = ";")) %>%
  dplyr::mutate(iteration = paste0("i", iteration))

shannon100_random_rural_nest <- shannon100_random_rural_list %>%
  split(.$iteration) %>%  # Split the data by 'iteration'
  purrr::set_names(names(.) %>% as.character())  %>%
  purrr::map(~ .x %>%
               # Convert the sample_ids and controls into long format (one sample per row)
               dplyr::bind_rows(
                 tibble(SampleID = unlist(strsplit(.x$sample_ids, ";")), coculture = "coculture"),
                 tibble(SampleID = unlist(strsplit(.x$controls, ";")), coculture = "control")
               ) %>%
               # Remove any extra columns and keep only 'sample' and 'type'
               dplyr::select(SampleID, coculture) %>%
               # Filter out rows where sample is NA or empty
               dplyr::filter(!is.na(sample) & SampleID != "")
             ) %>%
  purrr::map(~ merge(.x, meta2[,c("SampleID", "SampleName", "Batch", "urbanism", "Total.Reads_scaled")], by = "SampleID"))

saveRDS(shannon100_random_rural_nest, "results/rds/shannon100_random_rural_nest.rds")
write.csv(shannon100_random_rural_list, "results/docs/shannon100_random_rural_list.csv")
```




https://microbiome.github.io/tutorials/Betadiversity.html
Divergence from group median
```{r}
library(microbiome)

urban_phy <- subset_samples(phy, urbanism == "urban")
b.urban <- divergence(urban_phy, apply(abundances(urban_phy), 1, median))
names(b.urban) <- sample_names(urban_phy)

rural_phy <- subset_samples(phy, urbanism == "rural")
b.rural <- divergence(rural_phy, apply(abundances(rural_phy), 1, median))
names(b.rural) <- sample_names(rural_phy)

library(reshape2)
l<- list("urban"=b.urban, "rural"=b.rural)
df <- do.call(rbind, lapply(names(l), function(name) {
  data.frame(
    urbanism = name,                    # List name (urban or rural)
    SampleID = names(l[[name]]),        # Names of the values (Sample IDs)
    value = l[[name]]                   # Actual values
  )
}))

p<- ggplot(df, aes(x = urbanism, y = value)) + geom_boxplot()+ xlab('')

plot(p)

mann_whitney_result <- wilcox.test(value ~ urbanism, data = df)
Z <- mann_whitney_result$statistic  # This gives the W value
n1 <- sum(df$urbanism == "urban")  # Number of samples in urban group
n2 <- sum(df$urbanism == "rural")  # Number of samples in rural group
N <- n1 + n2  # Total number of samples
# Convert W to Z using the Mann-Whitney U test statistic
Z_score <- qnorm(mann_whitney_result$p.value)  # Use qnorm to calculate the Z from p-value
# Calculate effect size (r)
r <- Z_score / sqrt(N)
```

```{r}
# Load necessary libraries
library(phyloseq)
library(reshape2)
library(ggplot2)

# Define the function to apply the statistical test and calculate effect size
calculate_stats <- function(phy, sample_size = 10) {
  # Subset urban and rural phyloseq objects
  urban_phy <- subset_samples(phy, urbanism == "urban")
  rural_phy <- subset_samples(phy, urbanism == "rural")

  # Randomly select 'sample_size' samples from each group
 # set.seed(123)  # Set seed for reproducibility
  urban_samples <- sample(sample_names(urban_phy), sample_size)
  rural_samples <- sample(sample_names(rural_phy), sample_size)
  
  # Subset the phyloseq objects for the selected samples
  urban_phy_subset <- prune_samples(urban_samples, urban_phy)
  rural_phy_subset <- prune_samples(rural_samples, rural_phy)
  
  # Calculate the divergence for both subsets
  b.urban <- divergence(urban_phy_subset, apply(abundances(urban_phy_subset), 1, median))
  b.rural <- divergence(rural_phy_subset, apply(abundances(rural_phy_subset), 1, median))
  
  # Assign sample names to the values
  names(b.urban) <- sample_names(urban_phy_subset)
  names(b.rural) <- sample_names(rural_phy_subset)
  
  # Create a dataframe to store the results
  l <- list("urban" = b.urban, "rural" = b.rural)
  df <- do.call(rbind, lapply(names(l), function(name) {
    data.frame(
      urbanism = name,                     # List name (urban or rural)
      SampleID = names(l[[name]]),         # Sample IDs
      value = l[[name]]                    # Divergence values
    )
  }))
  
  # Perform Mann-Whitney U test
  mann_whitney_result <- wilcox.test(value ~ urbanism, data = df)
  p <- mann_whitney_result$p.value  
  W <- mann_whitney_result$statistic  # The W statistic
  n1 <- sum(df$urbanism == "urban")  # Number of urban samples
  n2 <- sum(df$urbanism == "rural")  # Number of rural samples
  N <- n1 + n2  # Total number of samples
  
  # Calculate the Z score (qnorm is used to approximate it from the p-value)
  Z_score <- qnorm(mann_whitney_result$p.value)  
  
  # Calculate effect size (r)
  r <- Z_score / sqrt(N)
  
  # Return the results as a data frame
  result <- data.frame(
    SampleID = paste(df$SampleID, collapse = ";"),  # Combine all Sample IDs with semicolon
    mann_whitney_pval = p,  
    effect_size_r = r           # Effect size (r)
  )
  
  return(result)
}

# Step 3: Apply the function over 100 iterations and gather the results
results_list <- vector("list", 100)  # List to store results
for (i in 1:100) {
  results_list[[i]] <- calculate_stats(phy, sample_size = 10)
}

# Combine the results into one data frame
final_results <- do.call(rbind, results_list)


```

```{r}
# Remove Inf values before processing
filtered_results <- final_results %>%
  filter(!is.infinite(effect_size_r))

# Find the minimum and maximum values
min_value <- min(filtered_results$effect_size_r)
max_value <- max(filtered_results$effect_size_r)

# Create a sequence of 8 equally spaced values between min and max
uniform_values <- seq(min_value, max_value, length.out = 10)[2:9]  # exclude min and max themselves

# Find the closest rows to each of the uniform values, taking only the first match
uniform_rows <- lapply(uniform_values, function(val) {
  closest_row <- filtered_results %>%
    filter(abs(effect_size_r - val) == min(abs(effect_size_r - val))) %>%
    slice(1)  # Take only the first row
  return(closest_row)
})

# Combine the rows corresponding to the min, max, and uniform values
final_results_select <- bind_rows(
  filtered_results %>% filter(effect_size_r == min_value),   # Row with min value
  filtered_results %>% filter(effect_size_r == max_value),   # Row with max value
  do.call(bind_rows, uniform_rows)                           # Rows corresponding to uniform values
)

write.csv(final_results_select, "results/docs/divergence_10sets.csv")


```
```{r}
ggplot(final_results, aes(x=effect_size_r)) +
  geom_histogram() +
  geom_vline(xintercept=-0.3790078, color="red") +
   geom_vline(data = final_results_select, aes(xintercept = effect_size_r), color = "green")
```


Number of unique species per sample
```{r}
unique_species_per_sample <- apply(t(otu_table(phy_filt_s)), 1, function(x) sum(x > 20)) 
unique_species_df <- data.frame(SampleName = names(unique_species_per_sample), 
                                UniqueSpeciesCount = unique_species_per_sample) %>%
  left_join(meta[,c("SampleName", "urbanism")])

ggplot(unique_species_df, aes(x = SampleName, y = UniqueSpeciesCount, fill = urbanism)) +
  geom_bar(stat = "identity") + 
  #ylim(values=c(100,150)) +
  facet_grid(~urbanism, space="free", scales="free") +
  coord_cartesian(ylim = c(100, 140)) +
  theme_linedraw()
```























Make a list of the microbes we will look at downstream (if differentially abundant)
```{r}
# Combine significant results
#clr_filt <- rbind(aldex2_clr_p_cts, aldex2_clr_c_cts) %>%
#  rbind(aldex2_clr_o_cts) %>%
#  rbind(aldex2_clr_f_cts) %>%
#  rbind(aldex2_clr_g_cts) %>%
#  rbind(aldex2_clr_s_cts) 

clr_filt <- rbind(aldex2_clr_p_cts, aldex2_clr_c_cts) %>%
  rbind(aldex2_clr_o_cts) %>%
  rbind(aldex2_clr_f_cts) %>%
  rbind(aldex2_clr_g_cts) %>%
  rbind(aldex2_clr_s_cts) 

clr_filt_DA <- clr_filt[row.names(aldex2_clr_all_sig),]

paste("pre-filt:",nrow(clr_filt))
paste("post-filt:",nrow(clr_filt_DA))
```

Save species and genus level abundances
```{r}
clr_filt_microbe_abundances <- clr_filt %>%
  t() %>%
  data.frame()

#write.csv(clr_filt_microbe_abundances, "results/docs/clr_filt_microbe_abundances.csv")

clr_filt_DA_microbe_abundances <- clr_filt_DA %>%
  t() %>%
  data.frame()

#write.csv(clr_filt_DA_microbe_abundances, "results/docs/clr_filt_DA_microbe_abundances.csv")
```

```{r}
test <- clr_filt_microbe_abundances %>%
  dplyr::select(Roseburia_hominis,
                Roseburia_sp_1,
                Anaerovibrio_sp900548165,
                Roseburia_faecis,
                Dorea_sp,
                Clostridium_sp_3,
                Eubacterium_sp_5,
                Ruminococcus_bicirculans,
                Clostridium_Q_fessum,
                Ruminococcus_sp_3,
                Bacteroides_dorei
                ) %>%
  rownames_to_column("SampleName") %>%
  pivot_longer(cols = -SampleName, names_to = "OTU", values_to = "CLR_abundance") %>%
  merge(meta[,c("SampleName", "urbanism")], by="SampleName")

ggplot(filter(test, OTU=="Bacteroides_dorei"), aes(x=urbanism, y=CLR_abundance, fill=urbanism)) +
  geom_boxplot() +
  geom_point() +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1")) + 
  theme_linedraw() + 
  labs(x = "Bacteroides_dorei", y = NULL) +  # Remove x and y axis titles
  theme(
    legend.position = "none",  # Remove the legend
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    text = element_text(size = 12),
    axis.title.x = element_text(face = 'italic')
  )
#ggsave("results/figs/RNAseq-metaG-microbe-SparseCCA/Lachnospiraceae_bacterium_GAM79.png", width=2, height=2)

```
```{r}
target_colnames <- c("Faecalibacterium",
                     "Faecalibacterium_sp_3",
                     "Bacteroides_ovatus",
                     "Bacteroides_caccae",
                     "Clostridiales",
                     "Lachnospiraceae",
                     "Spirochaetaceae",
                     "Treponema",
                     "Flavobacteriia",
                     "Flavobacteriaceae",
                     "Clostridiaceae",
                     "Clostridium",
                     "Akkermansiaceae",
                     "Akkermansia",
                     "Clostridiaceae",
                     "Clostridium",
                     "Erysipelotrichia",
                     "Erysipelotrichales",
                     "Enterobacter",
                     "Klebsiella",
                     "Anaerobutyricum",
                     "Klebsiella_pneumoniae",
                     "Veillonellaceae",
                     "Dialister_sp",
                     "Coprococcus",
                     "Coprococcus_sp",
                     "Unknown_genus_65",
                     "Lachnospiraceae_bacterium_GAM79",
                     "Bacteroides_finegoldii",
                     "Dorea_sp",
                     "Unknown_genus_15")
          

# Get the column names of your data frame
df_colnames <- colnames(clr_filt_DA_microbe_abundances)

# Find the intersection of the data frame's column names and your list
matching_colnames <- intersect(df_colnames, target_colnames)
matching_colnames
```


Post-filt distance matrix: species-level
```{r}
# Distance matrix
species_clr_dist <- ordinate(phy_clr_filt_s, distance="euclidean", method="PCoA") #"RDA"
# Gives position of every sample along first 36 axes
species_clr_dist_vectors <- species_clr_dist$vectors

species_clr_dist_select <- species_clr_dist_vectors %>%
  as.data.frame() %>%
  dplyr::select(c("Axis.1", "Axis.2")) %>%
  rownames_to_column("SampleName") %>%
  merge(meta[c("SampleID","SampleName","urbanism", "urbanism2", "country", "Shannon")], by="SampleName") 

species_clr_dist_pcoa <- plot_ordination(phy_clr_filt_s, species_clr_dist, type="sample") + 
  geom_point(aes(fill=urbanism), shape=21, size=3, stroke = 0.75) +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
  theme_linedraw() +
  #ylab("PC2: 13.5%") +
  ggtitle("Microbiome taxonomy: species-level; CLR") #+
  #theme(axis.title.x = element_blank())

#library(ggimage)
#species_clr_dist_pcoa_country <- plot_ordination(phy_clr_filt_s, species_clr_dist, type="sample") + 
#  geom_image(aes(image=image), size=.05) +
#  geom_point(aes(fill=urbanism), shape=21, size=3, stroke = 0.75) +
  #scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
#  theme_linedraw() +
  #ylab("PC2: 13.5%") +#
  #ggtitle("Microbiome taxonomy: species-level; CLR") #+
  #theme(axis.title.x = element_blank())

#species_clr_dist_pcoa_country

species_clr_dist_urbanism <- ggplot(species_clr_dist_select, aes(x=Axis.1, y=urbanism, fill=urbanism)) +
  geom_boxplot(alpha=0.65, outlier.size = 2.5) +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
  theme_linedraw() #+
  #xlab("PC1: 23.3%") +
  #theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())

#species_clr_dist_country <- ggplot(species_clr_dist_select, aes(x=Axis.1, y=country, fill=country)) +
#  geom_boxplot(alpha=0.65, outlier.size = 2.5) +
  #scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
#  theme_linedraw()

ggarrange(species_clr_dist_pcoa, species_clr_dist_urbanism, ncol=1, align = "v", heights=c(0.7, 0.3))
ggsave("results/figs/metaG-PCoA/species.png", width=5, height=4)
```
```{r}
wilcox.test(Axis.1 ~ urbanism, data = species_clr_dist_select)
leveneTest(Axis.1 ~ urbanism, data = species_clr_dist_select)
```


Corrleation of PC vectors to metadata
```{r}
total_reads <- as.data.frame((colSums(bracken_species_combined_num))) %>%
  dplyr::rename("total_reads" = 1) %>%
  rownames_to_column("SampleName")

meta_correct <- meta %>% 
  dplyr::select(country, sex, age) %>%
  rownames_to_column("SampleName") %>%
  left_join(total_reads, by="SampleName") %>%
  dplyr::filter(SampleName %in% row.names(species_clr_dist_vectors)) %>%
  dplyr::filter(!country == "USA") %>%
  column_to_rownames("SampleName")

species_clr_dist_vectors2 <- species_clr_dist_vectors[!grepl("^FMG", rownames(species_clr_dist_vectors)), , drop = FALSE]
species_clr_dist_vectors2 <- species_clr_dist_vectors2[,1:15]

meta_correct <- meta_correct[rownames(species_clr_dist_vectors2),]
meta_correct <- as.matrix(meta_correct)

# Recode categorical vars
meta_correct[,"country"] <- as.numeric(factor(meta_correct[,"country"]))
meta_correct[,"sex"] <- as.numeric(factor(meta_correct[,"sex"]))

# Assuming your matrix is called "my_matrix"
meta_correct2 <- apply(meta_correct, 2, as.numeric)
rownames(meta_correct2) <-rownames(meta_correct)
species_clr_dist_vectors3 <- apply(species_clr_dist_vectors2, 2, as.numeric)
rownames(species_clr_dist_vectors3) <-rownames(species_clr_dist_vectors2)

meta_cor <- cor(meta_correct2, species_clr_dist_vectors3)

library(RColorBrewer)
heatmap(meta_cor, Colv = NA, 
        col= colorRampPalette(brewer.pal(8, "Oranges"))(25))
legend(x="top", legend=c("min", "ave", "max"), 
     fill=colorRampPalette(brewer.pal(8, "Oranges"))(3))
```


Post-filt distance matrix: genus-level
```{r}
# Distance matrix
genus_clr_dist <- ordinate(phy_clr_filt_g, distance="euclidean", method="PCoA") #"RDA"
# Gives position of every sample along first 36 axes
genus_clr_dist_vectors <- genus_clr_dist$vectors

genus_clr_dist_select <- genus_clr_dist_vectors %>%
  as.data.frame() %>%
  dplyr::select(c("Axis.1", "Axis.2")) %>%
  rownames_to_column("SampleName") %>%
  merge(meta[c("SampleID","SampleName","urbanism", "urbanism2", "country", "Shannon")], by="SampleName") 

genus_clr_dist_pcoa <- plot_ordination(phy_clr_filt_g, genus_clr_dist, type="sample") + 
  geom_point(aes(fill=urbanism), shape=21, size=3, stroke = 0.75) +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
  theme_linedraw() +
  #ylab("PC2: 13.5%") +
  ggtitle("Microbiome taxonomy: genus-level; CLR") #+
  #theme(axis.title.x = element_blank())

#library(ggimage)
#species_clr_dist_pcoa_country <- plot_ordination(phy_clr_filt_s, species_clr_dist, type="sample") + 
#  geom_image(aes(image=image), size=.05) +
#  geom_point(aes(fill=urbanism), shape=21, size=3, stroke = 0.75) +
  #scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
#  theme_linedraw() +
  #ylab("PC2: 13.5%") +#
  #ggtitle("Microbiome taxonomy: species-level; CLR") #+
  #theme(axis.title.x = element_blank())

#species_clr_dist_pcoa_country

genus_clr_dist_urbanism <- ggplot(genus_clr_dist_select, aes(x=Axis.1, y=urbanism, fill=urbanism)) +
  geom_boxplot(alpha=0.65, outlier.size = 2.5) +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
  theme_linedraw() 
  #xlab("PC1: 23.3%") +
  #theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())

#species_clr_dist_country <- ggplot(species_clr_dist_select, aes(x=Axis.1, y=country, fill=country)) +
#  geom_boxplot(alpha=0.65, outlier.size = 2.5) +
  #scale_fill_manual(values=c("#6FBD8B", "#7B2BC1"), name = "Population") + #F42585
#  theme_linedraw()

ggarrange(genus_clr_dist_pcoa, genus_clr_dist_urbanism, ncol=1, align = "v", heights=c(0.7, 0.3))
#ggsave("results/figs/metaG-PCoA/species.png", width=5, height=4)
```
```{r}
wilcox.test(Axis.1 ~ urbanism, data = genus_clr_dist_select)

pc1_spread <- genus_clr_dist_select %>%
  dplyr::select(urbanism, Axis.1) %>%
  group_by(urbanism) %>%
  summarize(
    Mean = mean(Axis.1, na.rm = TRUE),
    Median = median(Axis.1, na.rm = TRUE),
    Variance = var(Axis.1, na.rm = TRUE),
    SD = sd(Axis.1, na.rm = TRUE),
    IQR = IQR(Axis.1, na.rm = TRUE), # Interquartile range
    Range = max(Axis.1, na.rm = TRUE) - min(Axis.1, na.rm = TRUE),
    Min = min(Axis.1, na.rm = TRUE),
    Max = max(Axis.1, na.rm = TRUE)
  )

print(pc1_spread)

library(car)
leveneTest(Axis.1 ~ urbanism, data = genus_clr_dist_select)

```

Relative abundance transformations for plotting purposes.
```{r}
# Transform to relative abundance
phy_r_filt_s = transform_sample_counts(phy_filt_s,function(x){x / sum(x)})
phy_r_filt_g = transform_sample_counts(phy_filt_g,function(x){x / sum(x)})
phy_r_filt_f = transform_sample_counts(phy_filt_f,function(x){x / sum(x)})
phy_r_filt_o = transform_sample_counts(phy_filt_o,function(x){x / sum(x)})
phy_r_filt_c = transform_sample_counts(phy_filt_c,function(x){x / sum(x)})
phy_r_filt_p = transform_sample_counts(phy_filt_p,function(x){x / sum(x)})
# CLR transformation
#phy_clr_filt_s <- microbiome::transform(phy_filt_s, "clr")
#phy_clr_filt_g <- microbiome::transform(phy_filt_g, "clr")
```
Genus barplot
```{r}
g_plot_df <- phy_r_filt_g %>%
  psmelt() %>%
  dplyr::select(g, Abundance) %>%
  group_by(g) %>%
  summarize(median = median(Abundance)) %>%
  left_join(psmelt(phy_r_filt_g), by = "g") %>%
  # Set threshold for "Other" coloring
  mutate(Genus = case_when(median < 0.005 ~ paste0('zOther (', 0.005*100, '% or less)'),
                             .default =g)) %>%
  mutate(SampleName = as.factor(SampleName))

# Sort according to bacteroides
bac_sort <- g_plot_df %>%
  subset(Genus == "Bacteroides") %>%
  arrange(Abundance)
g_plot_df$SampleName <- factor(g_plot_df$SampleName, levels = unlist(bac_sort$SampleName))

g_plot <- ggplot(g_plot_df, aes(x=SampleName, y=Abundance, fill=Genus)) + 
  #geom_point(aes(x=SampleName, y= 1.02, color=shreya_samps)) +
  #scale_color_manual(values=c("white", "red")) +
  geom_bar(aes(), stat="identity", position="stack") +
  scale_fill_manual(values=c(
    "#e2711d", # Bacteroides
    "#ff9100", # Blautia
    "#ffaa00", # Clostridium
    "#fee231", # Coprococcus
    "#eeef20", # Dorea
    "#c2cd4b", # Eubacterium
    "#84ba63", # Faecalibacterium
    "#4aa77c", # Oscillibacter
    "#28947f", # Parabacteroides
    "#2f94c6", # Prevotella
    "#277ba5", # Roseburia
    "#1f6284", # Ruminococcus
    #"#1f4289",
    "darkgrey"# Other
  )) +
  facet_grid(~urbanism, scales="free", space="free", labeller = as_labeller(c(rural="Non-Industrialized", urban="Industrialized"))) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg 
    legend.box.background = element_rect(fill = "transparent", color=NA), # get rid of legend panel bg and border
    legend.text = element_text(face = "italic"),
    #legend.position="bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.background =element_rect(fill=NA,))

g_plot
#ggsave("results/figs/metaG-stackedbar/genus.png", width=6.5, height=4)
```

Just open biome
```{r}
g_plot_df_ob <- phy_r_filt_g %>%
  psmelt() %>%
  dplyr::filter(., str_detect(SampleName, "FMG")) %>%
  dplyr::select(g, Abundance) %>%
  group_by(g) %>%
  summarize(median = median(Abundance)) %>%
  left_join(psmelt(phy_r_filt_g), by = "g") %>%
  dplyr::filter(., str_detect(SampleName, "FMG")) %>%
  # Set threshold for "Other" coloring
  mutate(Genus = case_when(median < 0.005 ~ paste0('zOther (', 0.005*100, '% or less)'),
                             .default =g)) %>%
  mutate(SampleName = as.factor(SampleName))

# Sort according to bacteroides
bac_sort_ob <- g_plot_df_ob %>%
  subset(Genus == "Bacteroides") %>%
  arrange(Abundance)
g_plot_df_ob$SampleName <- factor(g_plot_df_ob$SampleName, levels = unlist(bac_sort_ob$SampleName))

g_plot_ob <- ggplot(g_plot_df_ob, aes(x=SampleName, y=Abundance, fill=Genus)) + 
  #geom_point(aes(x=SampleName, y= 1.02, color=shreya_samps)) +
  #scale_color_manual(values=c("white", "red")) +
  geom_bar(aes(), stat="identity", position="stack") +
  scale_fill_manual(values=c(
    "#e2711d", # Bacteroides
    "#ff9100", # Blautia
    "#ffaa00", # Clostridium
    "#fee231", # Coprococcus
    "#eeef20", # Dorea
    "#c2cd4b", # Eubacterium
    "#84ba63", # Faecalibacterium
    "#4aa77c", # Oscillibacter
    "#28947f", # Parabacteroides
    "#2f94c6", # Prevotella
    "#277ba5", # Roseburia
    "#1f6284", # Ruminococcus
    "magenta",
    "purple",
    "black",
    #"#1f4289",
    "darkgrey"# Other
  )) +
  #facet_grid(~urbanism, scales="free", space="free", labeller = #as_labeller(c(rural="Non-Industrialized", urban="Industrialized"))) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg 
    legend.box.background = element_rect(fill = "transparent", color=NA), # get rid of legend panel bg and border
    legend.text = element_text(face = "italic"),
    #legend.position="bottom",
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.background =element_rect(fill=NA,))

g_plot_ob
```





Species barplot
```{r}
s_plot_df <- phy_r_filt_s %>%
  psmelt() %>%
  dplyr::select(s, Abundance) %>%
  group_by(s) %>%
  summarize(median = median(Abundance)) %>%
  left_join(psmelt(phy_r_filt_s), by = "s") %>%
  # Set threshold for "Other" coloring
  mutate(Species = case_when(median < 0.005 ~ paste0('zOther (', 0.005*100, '% or less)'),
                             .default = s)) %>%
  mutate(Species = str_replace_all(Species, "_", " ")) %>%
  mutate(SampleName = as.factor(SampleName))

# Sort in same order as genus
s_plot_df$SampleName <- factor(s_plot_df$SampleName, levels = unlist(bac_sort$SampleName))

s_plot <- ggplot(s_plot_df, aes(x=SampleName, y=Abundance, fill=Species)) +  
  #geom_point(aes(x=SampleName, y= 1.02, color=shreya_samps)) +
  #scale_color_manual(values=c("white", "red")) +
  geom_bar(aes(), stat="identity", position="stack") +
    scale_fill_manual(values=c(
    "#9b5ef9", # Bacteroides vulgatus
    "#9b5de5", # Bacteroides vulgatus
    "#c65ccd", # Eubacterium rectale
    "#f15bb5", # Faecalibacterium prausnitzii
    "#ef7a85", # Prevotella copri
    "#ffa2cb", # Prevotella sp
    "#b7e4c7", # Prevotella sp 1
    "#7fd09d", # Prevotella sp 2
    "#50d7d0", # Roseburia faecis
    "#8ec2f9", # Unknown 32
    "#4c9bf5", # Unknown 49
    "#1a7ef2", # Unknown 51
    "#4267ac", # Unknown 54
    "darkgrey"# Other
  )) +
  facet_grid(~urbanism, scales="free", space="free", labeller = as_labeller(c(rural="Non-Industrialized", urban="Industrialized"))) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg 
    legend.box.background = element_rect(fill = "transparent", color=NA), # get rid of legend panel bg and border
    legend.text = element_text(face = "italic"),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.background =element_rect(fill=NA,)) 
s_plot
#ggsave("results/figs/metaG-stackedbar/species.png", width=6.5, height=4)
write.csv(s_plot_df, file = "results/docs/s_plot_df.csv", row.names = FALSE)
```
```{r}
g_plot_df_cutoff <- g_plot_df %>%
  mutate(Genus = case_when(median < 0.001 ~ paste0('zOther (', 0.001*100, '% or less)'),
                             .default = g)) 
length(unique(g_plot_df_cutoff$Genus))
unique(g_plot_df_cutoff$Genus)

genus001 <- as.list(unique(g_plot_df_cutoff$Genus))
genus001 <- genus001[-1]

# Write list to a text file (one way is to convert to a character vector)
write.csv(data.frame(taxa=unlist(genus001)), file = "results/docs/genus001.csv", row.names = FALSE)

```
```{r}
s_plot_df_cutoff <- s_plot_df %>%
  mutate(Species = case_when(median < 0.001 ~ paste0('zOther (', 0.001*100, '% or less)'),
                             .default = s)) 
length(unique(s_plot_df_cutoff$Species))
unique(s_plot_df_cutoff$Species)

species001 <- as.list(unique(s_plot_df_cutoff$Species))
species001 <- species001[-2]

write.csv(data.frame(taxa=unlist(species001)), file = "results/docs/species001.csv", row.names = FALSE)
```


\
Now let's prepare the data we will use to export and test in DESeq. We will save the taxa with (1) highest median abundance, (2) significant differential abundance in urban vs. rural, and (3) strongest associations with PC1-microbiome. \
\
Medians
```{r}
medians_s <- phy_clr_filt_s %>%
  otu_table() %>%
  as.data.frame() %>%
  rownames_to_column("s") %>%
  rowwise() %>%
  mutate(median = median(c_across(where(is.numeric)))) %>%
  ungroup() %>%
  dplyr::arrange(desc(median)) %>%
  dplyr::top_n(30) %>%
  dplyr::select(s) %>%
  unlist()

medians_g <- phy_clr_filt_g %>%
  otu_table() %>%
  as.data.frame() %>%
  rownames_to_column("g") %>%
  rowwise() %>%
  mutate(median = median(c_across(where(is.numeric)))) %>%
  ungroup() %>%
  dplyr::arrange(desc(median)) %>%
  dplyr::top_n(30) %>%
  dplyr::select(g) %>%
  unlist()
```
Associations with PC1-microbiome
```{r}
# species
pc1_s <- species_clr_dist_vectors %>%
  as.data.frame() %>%
  dplyr::select(Axis.1) %>%
  merge(t(as.data.frame(otu_table(phy_clr_filt_s))), by="row.names") %>%
  column_to_rownames("Row.names")

pc1cor_s <- apply(pc1_s[, colnames(pc1_s)], 2, function(x) {
  result <- cor.test(x, unlist(pc1_s$Axis.1))
  result$conf.int <- NULL
  return(result)
})
pc1cor_s <- data.table::rbindlist(pc1cor_s, fill=TRUE, idcol = TRUE) %>%
  dplyr::rename(s=.id) %>% 
  dplyr::filter(!s=="Axis.1") %>%
  filter(p.value < 0.05) 

pc1cor_s <- c(list(pc1cor_s), 
              list(dplyr::filter(pc1cor_s, estimate < 0)),
              list(dplyr::filter(pc1cor_s, estimate > 0)))
pc1cor_s <- pc1cor_s %>% lapply(dplyr::select, s) 
pc1cor_s <- pc1cor_s %>% lapply(unlist) 
names(pc1cor_s) <- c("all", "rural", "urban")

# genus
pc1_g <- genus_clr_dist_vectors %>%
  as.data.frame() %>%
  dplyr::select(Axis.1) %>%
  merge(t(as.data.frame(otu_table(phy_clr_filt_g))), by="row.names") %>%
  column_to_rownames("Row.names")

pc1cor_g <- apply(pc1_g[, colnames(pc1_g)], 2, function(x) {
  result <- cor.test(x, unlist(pc1_g$Axis.1))
  result$conf.int <- NULL
  return(result)
})
pc1cor_g <- data.table::rbindlist(pc1cor_g, fill=TRUE, idcol = TRUE) %>%
  dplyr::rename(g=.id) %>% 
  dplyr::filter(!g=="Axis.1") %>%
  filter(p.value < 0.05) 

pc1cor_g <- c(list(pc1cor_g), 
              list(dplyr::filter(pc1cor_g, estimate < 0)),
              list(dplyr::filter(pc1cor_g, estimate > 0)))
pc1cor_g <- pc1cor_g %>% lapply(dplyr::select, g) 
pc1cor_g <- pc1cor_g %>% lapply(unlist) 
names(pc1cor_g) <- c("all", "rural", "urban")
```

Test differential abundance and generate candidate taxa for testing in DESeq2 (colonocyte RNA seq). ALDEx2 works great for CLR-transformed data.
https://www.nicholas-ollberding.com/post/introduction-to-the-statistical-analysis-of-microbiome-data-in-r/
```{r}
# Convert OTU table and sample data to data frames
aldex2_otu <- data.frame(phyloseq::otu_table(phy_filt_s)) 
colnames(aldex2_otu) <- sub("^X", "", colnames(aldex2_otu))
aldex2_otu2 <- aldex2_otu %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("SampleName")

aldex2_samp <- phyloseq::sample_data(phy_clr_filt_s)
aldex2_samp2 <- aldex2_samp %>%
  data.frame() %>%
  dplyr::select(SampleName, urbanism)

# Combine and summarize data
aldex2_summ <- aldex2_otu2 %>%
  inner_join(aldex2_samp2, by = "SampleName") %>%
  group_by(urbanism) %>%
  summarize(across(everything(), median)) %>%
  dplyr::select(-SampleName)

# Reshape the data
aldex2_summ <- aldex2_summ %>%
  pivot_longer(cols = -urbanism, names_to = "OTU", values_to = "median_abundance") %>%
  mutate(median_abundance = as.numeric(median_abundance), median_abundance_perc = median_abundance * 100)
  
ggplot(aldex2_summ, aes(x=median_abundance_perc, fill=urbanism)) +
  geom_histogram( color="#e9ecef", alpha=0.8, position = 'identity') +
  scale_fill_manual(values=c("#6FBD8B", "#7B2BC1")) +
  #scale_y_log10() +
  scale_x_log10(labels = scales::number_format(accuracy = 0.01)) +
  theme_linedraw() +
  facet_wrap(~urbanism)

# Based on histogram, let's limit the taxa to those with an abundance > 0.1%
aldex2_summ_filt <- aldex2_summ %>%
  dplyr::filter(median_abundance_perc > 0.1)

aldex2_otu_filt <- aldex2_otu %>%
  dplyr::filter(row.names(aldex2_otu) %in% unique(aldex2_summ_filt$OTU))

# ALL VALUES NEED TO BE INTEGERS
aldex2_da_s <- ALDEx2::aldex(aldex2_otu_filt, aldex2_samp$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_s, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

# EASIER TO INPUT ALL DATA, THEN FILTER THE DIFFERENTIAL ABUNDANCE RESULTS FOR TAXA WITH RA > 0.1%
# NEED TO INPUT RAW COUNTS

# Suggestion from marco: (1) minimum prevlaence filtering, (2) aldex for CLR and TSS (3) get clr differential abundance data (4) use TSS for making a stacked bar plot (5) filter differential abundance results for abundance

sig_aldex2_s <- aldex2_da_s %>%
  rownames_to_column(var = "s") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(s, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_s)
```

```{r}
aldex2_da_g <- ALDEx2::aldex(data.frame(phyloseq::otu_table(phy_filt_g)), phyloseq::sample_data(phy_filt_g)$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_g, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

sig_aldex2_g <- aldex2_da_g %>%
  rownames_to_column(var = "g") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(g, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_g)

aldex2_da_f <- ALDEx2::aldex(data.frame(phyloseq::otu_table(phy_filt_f)), phyloseq::sample_data(phy_filt_f)$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_f, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

sig_aldex2_f <- aldex2_da_f %>%
  rownames_to_column(var = "f") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(f, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_f)

aldex2_da_o <- ALDEx2::aldex(data.frame(phyloseq::otu_table(phy_filt_o)), phyloseq::sample_data(phy_filt_o)$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_o, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

sig_aldex2_o <- aldex2_da_o %>%
  rownames_to_column(var = "o") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(o, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_o)

aldex2_da_c <- ALDEx2::aldex(data.frame(phyloseq::otu_table(phy_filt_c)), phyloseq::sample_data(phy_filt_c)$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_c, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

sig_aldex2_c <- aldex2_da_c %>%
  rownames_to_column(var = "c") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(c, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_c)

aldex2_da_p <- ALDEx2::aldex(data.frame(phyloseq::otu_table(phy_filt_p)), phyloseq::sample_data(phy_filt_p)$urbanism, test="t", effect = TRUE, denom="iqlr")
ALDEx2::aldex.plot(aldex2_da_p, type="MW", test="wilcox", called.cex = 1, cutoff = 0.05)

sig_aldex2_p <- aldex2_da_p %>%
  rownames_to_column(var = "p") %>%
  filter(wi.eBH < 0.05) %>%
  arrange(effect, wi.eBH) %>%
  dplyr::select(p, diff.btw, diff.win, effect, wi.ep, wi.eBH)
head(sig_aldex2_p)
```
Explanation of columns:

* dif.btw - median difference in clr values between S and NS groups
* dif.win - median of the largest difference in clr values within S and NS groups
* effect - median effect size: diff.btw / max(diff.win) for all instances
* we.ep - Expected P value of Welchs t test
* we.eBH - Expected Benjamini-Hochberg corrected P value of Welchs t test
\
```{r}
diffabun_s <- c(list(sig_aldex2_s), 
              list(dplyr::filter(sig_aldex2_s, effect < 0)),
              list(dplyr::filter(sig_aldex2_s, effect > 0)))
diffabun_s <- diffabun_s %>% lapply(dplyr::select, s) 
diffabun_s <- diffabun_s %>% lapply(unlist) 
names(diffabun_s) <- c("all", "rural", "urban")

diffabun_g <- c(list(sig_aldex2_g), 
              list(dplyr::filter(sig_aldex2_g, effect < 0)),
              list(dplyr::filter(sig_aldex2_g, effect > 0)))
diffabun_g <- diffabun_g %>% lapply(dplyr::select, g) 
diffabun_g <- diffabun_g %>% lapply(unlist) 
names(diffabun_g) <- c("all", "rural", "urban")
```
\
\

While we are interested in how individual microbes correlate with host gene expression, we may get more power if we see how groups of microbes contribute to gene expression patterns. Ideally we are looking for sets of microbes that consistently appear in similar abundances sample-to-sample- even if their abundance is high in one sample and low in another. Then, even if we don't know exactly which microbe is causing the effect, we know that it's part of a specific set, and we know that set is associated with a certain lifestyle. 


sparse cca (sambhawas paper)
clustering approach





```{r}
test <- ALDEx2::aldex.clr(as.data.frame(phyloseq::otu_table(phy_filt_s)),
                    mc.samples=128, 
                    denom="all", 
                    verbose=F,
                    useMC=T) 

test2 <- aldex.corr(test, as.numeric(sample_data(phy)$PC1_uw))
test3 <- test2 %>% dplyr::filter(spearman.eBH < 0.1) %>% dplyr::select(spearman.erho, spearman.eBH)
test3
```



Exports 
```{r}
microbe_lists <- c(list(medians_s), list(medians_g), list(pc1cor_s), list(pc1cor_g), list(diffabun_s), list(diffabun_g))
names(microbe_lists) <- c("topabun_g", "topabun_s", "pc1cor_s", "pc1cor_g", "diffabun_g", "diffabun_s")

#saveRDS(microbe_lists, "results/docs/microbe_lists.rds")
```
```{r}
rm(list = ls())
```


